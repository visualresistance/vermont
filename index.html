<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vacant Lot: History, Futurity & Expression</title>
    
    <!-- Mapbox GL JS -->
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css' rel='stylesheet' />
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js'></script>
    
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div id="app">
        <!-- Landing Page -->
        <div id="landing-page" class="scene active">
            <!-- Full screen with matrix effect -->
            <div class="landing-videos">
                <div class="video-container video-container-full">
                    <video id="video-main" class="landing-video" autoplay loop muted playsinline>
                        <source src="assets/media/walk-right.mov" type="video/mp4">
                        <source src="assets/media/walk-right.m4v" type="video/mp4">
                        <source src="assets/media/walk-right.mp4" type="video/mp4">
                    </video>
                    <canvas id="canvas-main" class="video-scan-canvas"></canvas>
                </div>
            </div>
            
            <!-- Centered lot boundary with animated point -->
            <div class="landing-overlay">
                <svg id="lot-boundary-svg" viewBox="0 0 1000 1000" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <filter id="glow">
                            <feGaussianBlur stdDeviation="4" result="coloredBlur"/>
                            <feMerge>
                                <feMergeNode in="coloredBlur"/>
                                <feMergeNode in="SourceGraphic"/>
                            </feMerge>
                        </filter>
                    </defs>
                    
                    <!-- Polygon will be generated by JavaScript from lot-boundary.geojson -->
                    
                    <!-- Animated point that traces the boundary -->
                    <circle id="boundary-point" cx="500" cy="500" r="12" fill="#ff4444" stroke="#fff" stroke-width="2" filter="url(#glow)" class="pulsing"/>
                </svg>
                
                <div class="landing-title">
                    <h1>[Vermont]</h1>
                    <p>History, Futurity, and Possibilities</p>
                </div>
            </div>

            <!-- Navigation Bubbles - Clustered left and right of polygon -->
            <!-- Left Cluster (triangle formation) -->
            <div class="nav-bubble" data-adventure="presence" style="left: 18%; top: 28%; margin-left: -50px; margin-top: -50px;">
                Presence
            </div>

            <div class="nav-bubble" data-adventure="about" style="left: 12%; top: 50%; margin-left: -50px; margin-top: -50px;">
                About
            </div>

            <div class="nav-bubble" data-adventure="cases" style="left: 18%; top: 72%; margin-left: -50px; margin-top: -50px;">
                Cases
            </div>

            <!-- Right Cluster (triangle formation) -->
            <div class="nav-bubble" data-adventure="maps" style="left: 82%; top: 28%; margin-left: -50px; margin-top: -50px;">
                Maps
            </div>

            <div class="nav-bubble" data-adventure="create" style="left: 88%; top: 50%; margin-left: -50px; margin-top: -50px;">
                Create
            </div>

            <div class="nav-bubble" data-adventure="archive" style="left: 82%; top: 72%; margin-left: -50px; margin-top: -50px;">
                Archive
            </div>
        </div>

        <!-- Presence Section -->
        <div id="presence-section" class="scene">
            <video id="presence-video" autoplay loop muted playsinline>
                <source src="assets/media/vermont1.mov" type="video/mp4">
                Your browser does not support the video tag.
            </video>
        </div>

        <!-- Maps Section (Map) -->
        <div id="maps-section" class="scene">
            <div class="section-header">
                <button class="home-button" onclick="goHome()">← Home</button>
                <h2 class="section-title">Maps</h2>
            </div>
            <div id="map-container"></div>
        </div>

        <!-- Time Section (Timeline) -->
        <div id="time-section" class="scene">
            <div class="section-header">
                <button class="home-button" onclick="goHome()">← Home</button>
                <h2 class="section-title">Time</h2>
            </div>
            <div class="section-content">
                <div id="timeline-container"></div>
                <canvas id="fence-canvas"></canvas>
            </div>
        </div>

        <!-- Create Section -->
        <div id="create-section" class="scene">
            <div class="section-header">
                <button class="home-button" onclick="goHome()">← Home</button>
                <h2 class="section-title">Create</h2>
            </div>
            <div class="section-content">
                <div class="placeholder-content">More to come</div>
            </div>
        </div>

        <!-- Cases Section (Gallery) -->
        <div id="cases-section" class="scene">
            <div class="section-header">
                <button class="home-button" onclick="goHome()">← Home</button>
                <h2 class="section-title">Cases</h2>
            </div>
            <div class="section-content">
                <div id="cases-gallery"></div>
            </div>
            <!-- Modal for expanded view -->
            <div id="case-modal" class="modal">
                <div class="modal-content">
                    <span class="modal-close">&times;</span>
                    <div id="modal-body"></div>
                </div>
            </div>
        </div>

        <!-- About Section -->
        <div id="about-section" class="scene">
            <div class="section-header">
                <button class="home-button" onclick="goHome()">← Home</button>
                <h2 class="section-title">About</h2>
            </div>
            <div class="section-content">
                <div class="placeholder-content">More to come</div>
            </div>
        </div>
    </div>
    
    <script src="https://unpkg.com/konva@9/konva.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Configure PDF.js worker
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }
    </script>
    <script src="config.js"></script>
    <script src="js/mapbox-scene.js"></script>
    <script src="js/fence-scene.js"></script>
    <script src="js/transition.js"></script>
    <script src="js/timeline-scene.js"></script>
    <script src="js/cases-gallery.js"></script>
    <script src="js/boundary-animation.js"></script>
    <script src="js/video-scan-effect.js"></script>

    <script>
        // Navigation logic
        function showScene(sceneId) {
            console.log('[Navigation] showScene called with:', sceneId);
            const scenes = document.querySelectorAll('.scene');
            console.log('[Navigation] Found scenes:', scenes.length);
            scenes.forEach(s => {
                s.classList.remove('active');
                s.style.display = 'none';
                console.log('[Navigation] Removed active from:', s.id);
            });
            const targetScene = document.getElementById(sceneId);
            console.log('[Navigation] Target scene:', targetScene ? targetScene.id : 'NOT FOUND');
            if (targetScene) {
                targetScene.style.display = 'block';
                targetScene.classList.add('active');
                console.log('[Navigation] Added active to:', sceneId);
                
                // Initialize the appropriate section
                if (sceneId === 'presence-section') {
                    // Play video when entering presence section
                    const video = document.getElementById('presence-video');
                    if (video) {
                        video.play().catch(err => console.log('Video autoplay blocked:', err));
                    }
                } else if (sceneId === 'maps-section') {
                    // Initialize map if not already done
                    if (window.mapboxScene && typeof window.mapboxScene.initInteractiveMap === 'function' && !window.mapboxScene.map) {
                        try {
                            window.mapboxScene.initInteractiveMap();
                        } catch (err) {
                            console.error('Map init error:', err);
                        }
                    }
                } else if (sceneId === 'time-section') {
                    console.log('[Navigation] Initializing timeline scene...');
                    // Initialize timeline if needed
                    if (window.timelineScene && typeof window.timelineScene.init === 'function') {
                        try {
                            if (!window.timelineScene.stage) {
                                window.timelineScene.init();
                            }
                        } catch (err) {
                            console.error('Timeline scene error:', err);
                        }
                    } else {
                        console.error('[Navigation] timelineScene not found or init not a function');
                    }
                } else if (sceneId === 'cases-section') {
                    // Initialize cases gallery if needed
                    if (window.casesGallery && typeof window.casesGallery.init === 'function') {
                        try {
                            if (!window.casesGallery.initialized) {
                                window.casesGallery.init();
                            }
                        } catch (err) {
                            console.error('Cases gallery error:', err);
                        }
                    }
                }
            }
        }

        function goHome() {
            showScene('landing-page');
        }

        // Wire adventure icons to their sections
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize landing page animation
            if (window.landingAnimation) {
                window.landingAnimation.init();
            }
            
            // Setup presence video click-to-home
            const presenceVideo = document.getElementById('presence-video');
            if (presenceVideo) {
                presenceVideo.addEventListener('click', () => {
                    goHome();
                });
            }
            
            // Initialize circular text for navigation bubbles
            function initCircularText() {
                const navBubbles = document.querySelectorAll('.nav-bubble');
                navBubbles.forEach(bubble => {
                    const text = bubble.textContent.trim();
                    bubble.textContent = '';
                    
                    const textContainer = document.createElement('div');
                    textContainer.className = 'nav-bubble-text';
                    
                    const chars = text.split('');
                    const angleStep = 200 / chars.length; // Tighter spacing for readability
                    const startAngle = -10; // Center the arc
                    
                    chars.forEach((char, i) => {
                        const span = document.createElement('span');
                        span.textContent = char;
                        const angle = startAngle + (i * angleStep);
                        span.style.transform = `rotate(${angle}deg)`;
                        textContainer.appendChild(span);
                    });
                    
                    bubble.appendChild(textContainer);
                });
            }
            
            initCircularText();
            
            const navBubbles = document.querySelectorAll('.nav-bubble');
            navBubbles.forEach(bubble => {
                bubble.addEventListener('click', () => {
                    const adventure = bubble.getAttribute('data-adventure');
                    const sectionMap = {
                        'presence': 'presence-section',
                        'maps': 'maps-section',
                        'time': 'time-section',
                        'archive': 'time-section',
                        'create': 'create-section',
                        'cases': 'cases-section',
                        'about': 'about-section'
                    };
                    showScene(sectionMap[adventure]);
                });
            });

            // Error overlay setup (same as before)
            const showErrorOverlay = (msg) => {
                let ov = document.getElementById('error-overlay');
                if (!ov) {
                    ov = document.createElement('div');
                    ov.id = 'error-overlay';
                    Object.assign(ov.style, {
                        position: 'fixed', left: '0', right: '0', top: '0', bottom: '0',
                        background: 'rgba(0,0,0,0.6)', color: '#fff', zIndex: 99999,
                        display: 'flex', alignItems: 'center', justifyContent: 'center',
                        padding: '20px', fontFamily: 'sans-serif'
                    });
                    const box = document.createElement('div');
                    box.style.maxWidth = '900px';
                    box.style.background = '#1a1a1a';
                    box.style.padding = '18px';
                    box.style.borderRadius = '6px';
                    box.style.boxShadow = '0 8px 24px rgba(0,0,0,0.6)';
                    const h = document.createElement('h2'); h.textContent = 'An error occurred';
                    h.style.marginTop = '0';
                    const p = document.createElement('pre'); p.style.whiteSpace = 'pre-wrap'; p.style.color = '#ffdddd';
                    p.textContent = msg;
                    box.appendChild(h); box.appendChild(p);
                    ov.appendChild(box);
                    document.body.appendChild(ov);
                } else {
                    ov.querySelector('pre').textContent = msg;
                    ov.style.display = 'flex';
                }
            };

            window.addEventListener('error', (ev) => {
                const msg = ev.error && ev.error.stack ? ev.error.stack : (ev.message || String(ev));
                let ov = document.getElementById('error-overlay');
                if (!ov) {
                    ov = document.createElement('div');
                    ov.id = 'error-overlay';
                    Object.assign(ov.style, {
                        position: 'fixed', left: '0', right: '0', top: '0', bottom: '0',
                        background: 'rgba(0,0,0,0.6)', color: '#fff', zIndex: 99999,
                        display: 'flex', alignItems: 'center', justifyContent: 'center',
                        padding: '20px', fontFamily: 'sans-serif'
                    });
                    const box = document.createElement('div');
                    box.style.maxWidth = '900px';
                    box.style.background = '#1a1a1a';
                    box.style.padding = '18px';
                    box.style.borderRadius = '6px';
                    box.style.boxShadow = '0 8px 24px rgba(0,0,0,0.6)';
                    const h = document.createElement('h2'); h.textContent = 'Unhandled Error';
                    h.style.marginTop = '0';
                    const p = document.createElement('pre'); p.style.whiteSpace = 'pre-wrap'; p.style.color = '#ffdddd';
                    p.textContent = msg;
                    box.appendChild(h); box.appendChild(p);
                    ov.appendChild(box);
                    document.body.appendChild(ov);
                } else {
                    ov.querySelector('pre').textContent = msg;
                    ov.style.display = 'flex';
                }
            });
        });
    </script>
</body>
</html>